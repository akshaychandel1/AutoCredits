const Payment = ({ 
  form, 
  handleChange, 
  handleSave, 
  isSaving, 
  errors, 
  paymentHistory = [], 
  totalPremium, 
  onNextStep, 
  paymentLedger: propPaymentLedger, 
  onPaymentLedgerUpdate,
  acceptedQuote
}) => {
  // Format number in Indian digit format (e.g., 10,00,000)
  const formatIndianNumber = (number) => {
    if (!number && number !== 0) return '0';
    
    const num = parseFloat(number);
    if (isNaN(num)) return '0';
    
    // Handle decimal numbers
    const [integerPart, decimalPart] = num.toFixed(2).split('.');
    
    // Indian numbering system: 1,00,000 format
    const lastThree = integerPart.substring(integerPart.length - 3);
    const otherNumbers = integerPart.substring(0, integerPart.length - 3);
    
    if (otherNumbers !== '') {
      const formatted = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + "," + lastThree;
      return decimalPart ? `${formatted}.${decimalPart}` : formatted;
    }
    
    return decimalPart ? `${lastThree}.${decimalPart}` : lastThree;
  };

  // Comprehensive list of Indian banks for auto-suggest
const indianBanks = [
  "Bank of Baroda",
  "Bank of India",
  "Bank of Maharashtra",
  "Canara Bank",
  "Central Bank of India",
  "Indian Bank",
  "Indian Overseas Bank",
  "Punjab & Sind Bank",
  "Punjab National Bank",
  "State Bank of India",
  "UCO Bank",
  "Union Bank of India",
  "Axis Bank Ltd.",
  "Bandhan Bank Ltd.",
  "CSB Bank Ltd.",
  "City Union Bank Ltd.",
  "DCB Bank Ltd.",
  "Dhanlaxmi Bank Ltd.",
  "Federal Bank Ltd.",
  "HDFC Bank Ltd.",
  "ICICI Bank Ltd.",
  "IndusInd Bank Ltd.",
  "IDFC FIRST Bank Ltd.",
  "Jammu & Kashmir Bank Ltd.",
  "Karnataka Bank Ltd.",
  "Karur Vysya Bank Ltd.",
  "Kotak Mahindra Bank Ltd.",
  "Nainital Bank Ltd.",
  "RBL Bank Ltd.",
  "South Indian Bank Ltd.",
  "Tamilnad Mercantile Bank Ltd.",
  "YES Bank Ltd.",
  "IDBI Bank Ltd.",
  "Coastal Local Area Bank Ltd.",
  "Krishna Bhima Samruddhi Local Area Bank Ltd.",
  "AU Small Finance Bank Ltd.",
  "Capital Small Finance Bank Ltd.",
  "Equitas Small Finance Bank Ltd.",
  "ESAF Small Finance Bank Ltd.",
  "Suryoday Small Finance Bank Ltd.",
  "Ujjivan Small Finance Bank Ltd.",
  "Utkarsh Small Finance Bank Ltd.",
  "slice Small Finance Bank Ltd.",
  "Jana Small Finance Bank Ltd.",
  "Shivalik Small Finance Bank Ltd.",
  "Unity Small Finance Bank Ltd.",
  "Airtel Payments Bank Ltd.",
  "India Post Payments Bank Ltd.",
  "Fino Payments Bank Ltd.",
  "Paytm Payments Bank Ltd.",
  "Jio Payments Bank Ltd.",
  "NSDL Payments Bank Ltd.",
  "Assam Gramin Vikash Bank",
  "Andhra Pradesh Grameena Vikas Bank",
  "Andhra Pragathi Grameena Bank",
  "Arunachal Pradesh Rural Bank",
  "Aryavart Bank",
  "Bangiya Gramin Vikash Bank",
  "Baroda Gujarat Gramin Bank",
  "Baroda Rajasthan Kshetriya Gramin Bank",
  "Baroda UP Bank",
  "Chaitanya Godavari Grameena Bank",
  "Chhattisgarh Rajya Gramin Bank",
  "Dakshin Bihar Gramin Bank",
  "Ellaquai Dehati Bank",
  "Himachal Pradesh Gramin Bank",
  "J&K Grameen Bank",
  "Jharkhand Rajya Gramin Bank",
  "Karnataka Gramin Bank",
  "Karnataka Vikas Grameena Bank",
  "Kerala Gramin Bank",
  "Madhya Pradesh Gramin Bank",
  "Madhyanchal Gramin Bank",
  "Maharashtra Gramin Bank",
  "Manipur Rural Bank",
  "Meghalaya Rural Bank",
  "Mizoram Rural Bank",
  "Nagaland Rural Bank",
  "Odisha Gramya Bank",
  "Paschim Banga Gramin Bank",
  "Prathama U.P. Gramin Bank",
  "Puduvai Bharathiar Grama Bank",
  "Punjab Gramin Bank",
  "Rajasthan Marudhara Gramin Bank",
  "Saptagiri Grameena Bank",
  "Sarva Haryana Gramin Bank",
  "Saurashtra Gramin Bank",
  "Tamil Nadu Grama Bank",
  "Telangana Grameena Bank",
  "Tripura Gramin Bank",
  "Uttar Bihar Gramin Bank",
  "Utkal Grameen Bank",
  "Uttarbanga Kshetriya Gramin Bank",
  "Vidharbha Konkan Gramin Bank",
  "Uttarakhand Gramin Bank",
  "AB Bank Ltd.",
  "American Express Banking Corporation",
  "Australia and New Zealand Banking Group Ltd.",
  "Barclays Bank PLC",
  "Bank of America",
  "Bank of Bahrain and Kuwait B.S.C.",
  "Bank of Ceylon",
  "Bank of China Ltd.",
  "Bank of Nova Scotia",
  "BNP Paribas",
  "Citibank N.A.",
  "CoÃ¶peratieve Rabobank U.A.",
  "Credit Agricole CIB",
  "CTBC Bank Co., Ltd.",
  "DBS Bank India Ltd.",
  "Deutsche Bank AG",
  "Doha Bank Q.P.S.C",
  "Emirates NBD Bank P.J.S.C",
  "First Abu Dhabi Bank PJSC",
  "FirstRand Bank Ltd.",
  "HSBC",
  "Industrial and Commercial Bank of China",
  "Industrial Bank of Korea",
  "J.P. Morgan Chase Bank N.A.",
  "JSC VTB Bank",
  "KEB Hana Bank",
  "Kookmin Bank",
  "Mashreqbank P.S.C.",
  "Mizuho Bank Ltd.",
  "MUFG Bank, Ltd.",
  "NongHyup Bank",
  "NatWest Markets Plc",
  "PT Bank Maybank Indonesia Tbk",
  "Qatar National Bank (Q.P.S.C.)",
  "Sberbank",
  "Bajaj Finance Ltd.",
  "Shriram Finance Ltd.",
  "Mahindra & Mahindra Financial Services Ltd.",
  "LIC Housing Finance Ltd.",
  "PNB Housing Finance Ltd.",
  "Sundaram Finance Ltd.",
  "L&T Finance Ltd."
];



  // State for bank suggestions - now separate for each field
  const [bankSuggestions, setBankSuggestions] = useState({
    customer: [],
    inHouse: [],
    autoCredit: []
  });
  const [showSuggestions, setShowSuggestions] = useState({
    customer: false,
    inHouse: false,
    autoCredit: false
  });
  const [activeBankIndex, setActiveBankIndex] = useState({
    customer: -1,
    inHouse: -1,
    autoCredit: -1
  });

  // State for editing payment
  const [editingPayment, setEditingPayment] = useState(null);
  const [editFormData, setEditFormData] = useState({});

  // State for subvention/discount
  const [showSubventionForm, setShowSubventionForm] = useState(false);
  const [subventionAmount, setSubventionAmount] = useState('');
  const [subventionReason, setSubventionReason] = useState('');
  const [subventionEntries, setSubventionEntries] = useState([]);

  // Use the final premium amount directly from acceptedQuote
  const finalPremiumAmount = acceptedQuote?.totalPremium || 0;

  // State for payment ledger - use prop if provided, otherwise local state
  const [paymentLedger, setPaymentLedger] = useState(propPaymentLedger || paymentHistory || []);
  
  // State for auto credit amount - equals final premium minus subvention refunds
  const [autoCreditAmount, setAutoCreditAmount] = useState(finalPremiumAmount || "");

  // FIXED: Sync payment ledger with parent component
  useEffect(() => {
    if (propPaymentLedger && JSON.stringify(propPaymentLedger) !== JSON.stringify(paymentLedger)) {
      setPaymentLedger(propPaymentLedger);
    }
  }, [propPaymentLedger]);

  // FIXED: Recalculate totals when ledger changes
  useEffect(() => {
    const totalCustomerPayments = calculateTotalCustomerPayments();
    const paymentStatus = calculateOverallPaymentStatus();
    
    handleChange({
      target: {
        name: 'paymentStatus',
        value: paymentStatus
      }
    });

    handleChange({
      target: {
        name: 'totalPaidAmount',
        value: totalCustomerPayments
      }
    });
  }, [paymentLedger]);

  // Calculate total customer payments (both direct and via in house)
  const calculateTotalCustomerPayments = () => {
    return paymentLedger
      .filter(payment => payment.paymentMadeBy === "Customer" && payment.type !== "subvention_refund")
      .reduce((sum, payment) => sum + payment.amount, 0);
  };

  // Calculate remaining amount that customer can pay
  const calculateCustomerRemainingAmount = () => {
    const totalCustomerPayments = calculateTotalCustomerPayments();
    const totalSubventionRefund = calculateTotalSubventionRefund();
    const netAmount = finalPremiumAmount - totalSubventionRefund;
    return Math.max(netAmount - totalCustomerPayments, 0);
  };

  // Calculate payment progress percentage (based only on customer payments)
  const calculatePaymentProgress = () => {
    const totalCustomerPayments = calculateTotalCustomerPayments();
    const totalSubventionRefund = calculateTotalSubventionRefund();
    const netPremium = Math.max(finalPremiumAmount - totalSubventionRefund, 0);
    
    return netPremium > 0 ? Math.min((totalCustomerPayments / netPremium) * 100, 100) : 100;
  };

  // Calculate overall payment status (based only on customer payments)
  const calculateOverallPaymentStatus = () => {
    const totalCustomerPayments = calculateTotalCustomerPayments();
    const totalSubventionRefund = calculateTotalSubventionRefund();
    const netPremium = Math.max(finalPremiumAmount - totalSubventionRefund, 0);
    
    return totalCustomerPayments >= netPremium ? 'Fully Paid' : 'Payment Pending';
  };

  // FIXED: Calculate individual payment status - Customer payments show Pending if remaining amount > 0
  const calculatePaymentStatus = (payment) => {
    if (payment.type === "auto_credit") {
      return 'Completed'; // Auto credit always completed
    }
    
    if (payment.type === "subvention_refund") {
      return 'Completed'; // Subvention refunds always completed
    }
    
    // For customer payments, check if total paid covers the payment
    const totalCustomerPayments = calculateTotalCustomerPayments();
    const totalSubventionRefund = calculateTotalSubventionRefund();
    const netPremium = Math.max(finalPremiumAmount - totalSubventionRefund, 0);
    
    if (payment.paymentMadeBy === "Customer") {
      return totalCustomerPayments >= netPremium ? 'Completed' : 'Pending';
    }
    
    return payment.status || 'Completed';
  };
  
  // Payment modes for Customer (includes subvention)
  const customerPaymentModeOptions = [
    "Online Transfer/UPI",
    "Cash",
    "Cheque",
    "Credit/Debit Card"
  ];

  // Payment modes for In House (excludes subvention)
  const inHousePaymentModeOptions = [
    "Online Transfer/UPI",
    "Cash",
    "Cheque",
    "Credit/Debit Card"
  ];

  // Payment made by options
  const paymentMadeByOptions = [
    { value: "Customer", label: "Customer" },
    { value: "In House", label: "In House" }
  ];

  // Calculate total subvention refund amount - FIXED: Consistent calculation
  const calculateTotalSubventionRefund = () => {
    return paymentLedger
      .filter(payment => payment.type === "subvention_refund")
      .reduce((sum, payment) => sum + payment.amount, 0);
  };

  // NEW: Handle adding individual subvention amounts one by one
  const handleAddSubventionEntry = () => {
    if (!subventionAmount || subventionAmount <= 0) {
      alert("Please enter a valid subvention amount");
      return;
    }

    const amount = parseFloat(subventionAmount);
    const totalSubventionRefund = calculateTotalSubventionRefund();
    const remainingSubventionCapacity = finalPremiumAmount - totalSubventionRefund;

    if (amount > remainingSubventionCapacity) {
      alert(`Subvention amount cannot exceed remaining capacity of â‚¹${formatIndianNumber(remainingSubventionCapacity)}`);
      return;
    }

    const newEntry = {
      id: Date.now().toString(),
      amount: amount,
      reason: subventionReason || "Subvention discount"
    };

    setSubventionEntries(prev => [...prev, newEntry]);
    setSubventionAmount('');
    setSubventionReason('');
  };

  // NEW: Handle final subvention submission
  const handleSubventionRefund = async () => {
    if (subventionEntries.length === 0) {
      alert("Please add at least one subvention entry");
      return;
    }

    const totalSubventionAmount = subventionEntries.reduce((sum, entry) => sum + entry.amount, 0);
    const totalExistingSubvention = calculateTotalSubventionRefund();
    
    if (totalSubventionAmount > finalPremiumAmount) {
      alert("Total subvention amount cannot exceed final premium amount");
      return;
    }

    try {
      // Create subvention refund entries for each subvention entry
      const subventionRefunds = subventionEntries.map(entry => ({
        id: Date.now().toString() + '_subvention_refund_' + entry.id,
        date: new Date().toISOString().split('T')[0],
        description: `Subvention Refund - ${entry.reason}`,
        amount: entry.amount,
        mode: "Subvention Refund",
        status: 'Completed',
        transactionId: 'N/A',
        bankName: 'N/A',
        paymentMadeBy: "In House",
        receiptDate: new Date().toISOString().split('T')[0],
        payoutBy: "Customer",
        type: "subvention_refund"
      }));

      const updatedLedger = [...paymentLedger, ...subventionRefunds];
      
      // Update auto credit status if needed
      const updatedLedgerWithAutoCreditStatus = updateAutoCreditStatus(updatedLedger);
      
      // FIXED: Update state immediately
      setPaymentLedger(updatedLedgerWithAutoCreditStatus);
      
      // FIXED: Notify parent component immediately
      if (onPaymentLedgerUpdate) {
        onPaymentLedgerUpdate(updatedLedgerWithAutoCreditStatus);
      }
      
      // Update payment status and totals
      const totalCustomerPayments = calculateTotalCustomerPayments();
      const paymentStatus = calculateOverallPaymentStatus();

      const paymentData = {
        payment_info: {
          paymentMadeBy: form.paymentMadeBy,
          paymentMode: form.paymentMode || "",
          paymentAmount: parseFloat(form.paymentAmount) || 0,
          paymentDate: form.paymentDate || '',
          transactionId: form.transactionId || '',
          receiptDate: form.receiptDate || '',
          bankName: form.bankName || '',
          subvention_payment: "Subvention Refund Applied",
          paymentStatus: paymentStatus,
          totalPaidAmount: totalCustomerPayments,
          totalSubventionRefund: totalSubventionAmount + totalExistingSubvention
        },
        payment_ledger: updatedLedgerWithAutoCreditStatus
      };

      console.log("ðŸ’° Adding subvention refunds:", paymentData);

      // Save to backend
      await handleSave(paymentData);
      
      // Clear subvention form and entries
      setSubventionEntries([]);
      setSubventionAmount('');
      setSubventionReason('');
      setShowSubventionForm(false);
      
      alert(`Subvention refunds totaling â‚¹${formatIndianNumber(totalSubventionAmount)} added successfully!`);
      
    } catch (error) {
      console.error('Error saving subvention refund:', error);
      alert('Error saving subvention refund. Please try again.');
    }
  };

  // NEW: Remove individual subvention entry
  const handleRemoveSubventionEntry = (entryId) => {
    setSubventionEntries(prev => prev.filter(entry => entry.id !== entryId));
  };

  // Check if auto credit entry exists and get its status
  const getAutoCreditEntry = () => {
    return paymentLedger.find(payment => payment.type === "auto_credit");
  };

  // FIXED: Calculate auto credit status - Should always show Completed when created
  const calculateAutoCreditStatus = () => {
    const autoCreditEntry = getAutoCreditEntry();
    
    if (!autoCreditEntry) return 'Not Created';
    
    // Auto credit to insurance company should always show as Completed
    // because it represents the commitment to pay the insurance company
    return 'Completed';
  };

  // IMPROVED: Handle bank name input change with auto-suggest - now field-specific
  const handleBankNameChange = (e, bankType = 'customer') => {
    const value = e.target.value;
    
    // Update the form state
    if (bankType === 'customer') {
      handleChange({
        target: {
          name: 'customerBankName',
          value: value
        }
      });
    } else if (bankType === 'inHouse') {
      handleChange({
        target: {
          name: 'inHouseBankName',
          value: value
        }
      });
    } else if (bankType === 'autoCredit') {
      handleChange({
        target: {
          name: 'autoCreditBankName',
          value: value
        }
      });
    }
    
    // Show suggestions for this specific field if input is not empty
    if (value.length > 0) {
      const filteredBanks = indianBanks.filter(bank =>
        bank.toLowerCase().includes(value.toLowerCase())
      );
      
      setBankSuggestions(prev => ({
        ...prev,
        [bankType]: filteredBanks
      }));
      
      setShowSuggestions(prev => ({
        ...prev,
        [bankType]: true
      }));
      
      setActiveBankIndex(prev => ({
        ...prev,
        [bankType]: -1
      }));
    } else {
      setShowSuggestions(prev => ({
        ...prev,
        [bankType]: false
      }));
      
      setBankSuggestions(prev => ({
        ...prev,
        [bankType]: []
      }));
    }
  };

  // IMPROVED: Handle bank focus - show suggestions when field is focused
  const handleBankFocus = (bankType = 'customer') => {
    const currentValue = 
      bankType === 'customer' ? form.customerBankName || '' :
      bankType === 'inHouse' ? form.inHouseBankName || '' :
      form.autoCreditBankName || '';
    
    if (currentValue.length > 0) {
      const filteredBanks = indianBanks.filter(bank =>
        bank.toLowerCase().includes(currentValue.toLowerCase())
      );
      
      setBankSuggestions(prev => ({
        ...prev,
        [bankType]: filteredBanks
      }));
    } else {
      setBankSuggestions(prev => ({
        ...prev,
        [bankType]: indianBanks.slice(0, 10) // Show top 10 banks when empty
      }));
    }
    
    setShowSuggestions(prev => ({
      ...prev,
      [bankType]: true
    }));
  };

  // IMPROVED: Handle bank suggestion selection
  const handleBankSelect = (bankName, bankType = 'customer') => {
    if (bankType === 'customer') {
      handleChange({
        target: {
          name: 'customerBankName',
          value: bankName
        }
      });
    } else if (bankType === 'inHouse') {
      handleChange({
        target: {
          name: 'inHouseBankName',
          value: bankName
        }
      });
    } else if (bankType === 'autoCredit') {
      handleChange({
        target: {
          name: 'autoCreditBankName',
          value: bankName
        }
      });
    }
    
    setShowSuggestions(prev => ({
      ...prev,
      [bankType]: false
    }));
    
    setActiveBankIndex(prev => ({
      ...prev,
      [bankType]: -1
    }));
  };

  // IMPROVED: Handle keyboard navigation for bank suggestions - field specific
  const handleBankKeyDown = (e, bankType = 'customer') => {
    if (!showSuggestions[bankType]) return;

    const currentSuggestions = bankSuggestions[bankType];
    const currentActiveIndex = activeBankIndex[bankType];

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        setActiveBankIndex(prev => ({
          ...prev,
          [bankType]: currentActiveIndex < currentSuggestions.length - 1 ? currentActiveIndex + 1 : currentActiveIndex
        }));
        break;
      case 'ArrowUp':
        e.preventDefault();
        setActiveBankIndex(prev => ({
          ...prev,
          [bankType]: currentActiveIndex > 0 ? currentActiveIndex - 1 : -1
        }));
        break;
      case 'Enter':
        e.preventDefault();
        if (currentActiveIndex >= 0 && currentSuggestions[currentActiveIndex]) {
          handleBankSelect(currentSuggestions[currentActiveIndex], bankType);
        }
        break;
      case 'Escape':
        setShowSuggestions(prev => ({
          ...prev,
          [bankType]: false
        }));
        setActiveBankIndex(prev => ({
          ...prev,
          [bankType]: -1
        }));
        break;
      default:
        break;
    }
  };

  // IMPROVED: Close suggestions when clicking outside - field specific
  useEffect(() => {
    const handleClickOutside = (event) => {
      const bankInputs = document.querySelectorAll('.bank-suggestions-container input[type="text"]');
      let isBankInput = false;
      
      bankInputs.forEach(input => {
        if (input.contains(event.target)) {
          isBankInput = true;
        }
      });
      
      if (!isBankInput) {
        setShowSuggestions({
          customer: false,
          inHouse: false,
          autoCredit: false
        });
        setActiveBankIndex({
          customer: -1,
          inHouse: -1,
          autoCredit: -1
        });
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  // Handle radio button change
  const handleRadioChange = (fieldName, value) => {
    handleChange({ 
      target: { 
        name: fieldName, 
        value: value 
      } 
    });
  };

  // Handle auto credit amount change - FIXED: Always use final premium amount
  const handleAutoCreditChange = (e) => {
    // Prevent any changes to auto credit amount - always use final premium
    setAutoCreditAmount(finalPremiumAmount);
    handleChange({
      target: {
        name: 'autoCreditAmount',
        value: finalPremiumAmount
      }
    });
  };

  // FIXED: EDIT PAYMENT FUNCTIONS - Completely rewritten input handling
  const handleEditPayment = (payment) => {
    console.log("Editing payment:", payment);
    setEditingPayment(payment.id);
    setEditFormData({
      date: payment.date,
      description: payment.description,
      amount: payment.amount.toString(), // Store as string for free editing
      mode: payment.mode,
      status: payment.status,
      transactionId: payment.transactionId || '',
      bankName: payment.bankName || '',
      paymentMadeBy: payment.paymentMadeBy,
      receiptDate: payment.receiptDate || payment.date,
      payoutBy: payment.payoutBy
    });
  };

  // FIXED: Edit payment function that works with the new EditPaymentForm component
  const handleSaveEdit = async (editedData) => {
    console.log("Saving edited payment:", editedData);
    
    if (!editedData.amount || !editedData.date || !editedData.mode) {
      alert("Please fill all required fields (Amount, Date, and Payment Mode)");
      return;
    }

    try {
      const updatedLedger = paymentLedger.map(payment => 
        payment.id === editingPayment 
          ? { 
              ...payment, 
              ...editedData
            }
          : payment
      );

      console.log("Updated ledger after edit:", updatedLedger);

      // Update auto credit status if needed
      const updatedLedgerWithAutoCreditStatus = updateAutoCreditStatus(updatedLedger);
      
      // FIXED: Update local state immediately
      setPaymentLedger(updatedLedgerWithAutoCreditStatus);
      
      // FIXED: Notify parent component about ledger update immediately
      if (onPaymentLedgerUpdate) {
        onPaymentLedgerUpdate(updatedLedgerWithAutoCreditStatus);
      }
      
      // Update payment status and totals
      const totalCustomerPayments = calculateTotalCustomerPayments();
      const paymentStatus = calculateOverallPaymentStatus();

      const paymentData = {
        payment_info: {
          paymentMadeBy: form.paymentMadeBy || "Customer",
          paymentMode: form.paymentMode || "",
          paymentAmount: parseFloat(form.paymentAmount) || 0,
          paymentDate: form.paymentDate || '',
          transactionId: form.transactionId || '',
          receiptDate: form.receiptDate || '',
          bankName: form.bankName || '',
          subvention_payment: form.paymentMode?.includes('Subvention') ? form.paymentMode : "No Subvention",
          paymentStatus: paymentStatus,
          totalPaidAmount: totalCustomerPayments
        },
        payment_ledger: updatedLedgerWithAutoCreditStatus
      };

      console.log("Saving payment data after edit:", paymentData);

      // Save to backend
      await handleSave(paymentData);
      
      // FIXED: Close edit form only after successful save
      setEditingPayment(null);
      
      alert("Payment updated successfully!");
      
    } catch (error) {
      console.error('Error saving edited payment:', error);
      alert('Error saving edited payment. Please try again.');
    }
  };

  const handleCancelEdit = () => {
    setEditingPayment(null);
    setEditFormData({});
  };

  // Add payment to ledger function for Customer
  const addCustomerPaymentToLedger = async () => {
    if (!form.customerPaymentAmount || !form.customerPaymentDate || !form.customerPaymentMode) {
      alert("Please fill all required payment fields for Customer payment");
      return;
    }

    const paymentAmount = parseFloat(form.customerPaymentAmount);
    const customerRemainingAmount = calculateCustomerRemainingAmount();

    // Check if payment amount exceeds remaining amount
    if (paymentAmount > customerRemainingAmount) {
      alert(`Payment amount cannot exceed remaining amount of â‚¹${formatIndianNumber(customerRemainingAmount)}`);
      return;
    }

    // FIXED: Calculate status based on remaining amount
    const totalCustomerPayments = calculateTotalCustomerPayments();
    const totalSubventionRefund = calculateTotalSubventionRefund();
    const netPremium = Math.max(finalPremiumAmount - totalSubventionRefund, 0);
    const paymentStatus = (totalCustomerPayments + paymentAmount) >= netPremium ? 'Completed' : 'Pending';

    const newPayment = {
      id: Date.now().toString() + '_customer',
      date: form.customerPaymentDate,
      description: `Customer Payment - ${form.customerPaymentMode}`,
      amount: paymentAmount,
      mode: form.customerPaymentMode,
      status: paymentStatus, // FIXED: Dynamic status based on remaining amount
      transactionId: form.customerTransactionId || 'N/A',
      bankName: form.customerBankName || 'N/A',
      paymentMadeBy: "Customer",
      receiptDate: form.customerReceiptDate || form.customerPaymentDate,
      payoutBy: "Customer",
      type: "customer_payment"
    };

    const updatedLedger = [...paymentLedger, newPayment];
    
    // Update auto credit status if it exists
    const updatedLedgerWithAutoCreditStatus = updateAutoCreditStatus(updatedLedger);
    
    // FIXED: Update state immediately
    setPaymentLedger(updatedLedgerWithAutoCreditStatus);
    
    // FIXED: Notify parent component immediately
    if (onPaymentLedgerUpdate) {
      onPaymentLedgerUpdate(updatedLedgerWithAutoCreditStatus);
    }
    
    // Update payment status and totals
    const newTotalCustomerPayments = calculateTotalCustomerPayments();
    const overallPaymentStatus = calculateOverallPaymentStatus();

    const paymentData = {
      payment_info: {
        paymentMadeBy: "Customer",
        paymentMode: form.customerPaymentMode,
        paymentAmount: paymentAmount,
        paymentDate: form.customerPaymentDate,
        transactionId: form.customerTransactionId || '',
        receiptDate: form.customerReceiptDate || form.customerPaymentDate,
        bankName: form.customerBankName || '',
        subvention_payment: form.customerPaymentMode.includes('Subvention') ? form.customerPaymentMode : "No Subvention",
        paymentStatus: overallPaymentStatus,
        totalPaidAmount: newTotalCustomerPayments
      },
      payment_ledger: updatedLedgerWithAutoCreditStatus
    };

    console.log("ðŸ’° Adding Customer payment to ledger:", paymentData);

    try {
      // Save to backend
      await handleSave(paymentData);
      
      // Clear customer payment form (keep payment mode for convenience)
      handleChange({ target: { name: 'customerPaymentAmount', value: '' } });
      handleChange({ target: { name: 'customerPaymentDate', value: '' } });
      handleChange({ target: { name: 'customerTransactionId', value: '' } });
      handleChange({ target: { name: 'customerReceiptDate', value: '' } });
      handleChange({ target: { name: 'customerBankName', value: '' } });
      
    } catch (error) {
      console.error('Error saving customer payment:', error);
      alert('Error saving customer payment. Please try again.');
    }
  };

  // UPDATED: Add payment to ledger function for In House - Now allows either auto credit OR customer payment independently
  const addInHousePaymentToLedger = async () => {
    // Check if at least one section (Auto Credit OR Customer Payment) is filled
    const isAutoCreditFilled = form.autoCreditPaymentMode && form.autoCreditPaymentDate;
    const isCustomerPaymentFilled = form.inHousePaymentAmount && form.inHousePaymentDate && form.inHousePaymentMode;
    
    if (!isAutoCreditFilled && !isCustomerPaymentFilled) {
      alert("Please fill either Auto Credit section OR Customer Payment section");
      return;
    }

    let updatedLedger = [...paymentLedger];

    // Add auto credit entry if auto credit section is filled
    if (isAutoCreditFilled) {
      // Check if auto credit entry already exists for this premium
      const existingAutoCredit = getAutoCreditEntry();

      // Add auto credit entry only if it doesn't exist
      if (!existingAutoCredit) {
        const autoCreditPayment = {
          id: Date.now().toString() + '_auto_credit',
          date: form.autoCreditPaymentDate,
          description: `Auto Credit to Insurance Company - ${form.autoCreditPaymentMode}`,
          amount: finalPremiumAmount, // Use final premium amount here instead of netPremium
          mode: form.autoCreditPaymentMode,
          status: 'Completed', // FIXED: Always show as Completed
          transactionId: form.autoCreditTransactionId || 'N/A',
          bankName: form.autoCreditBankName || 'N/A',
          paymentMadeBy: "In House",
          receiptDate: form.autoCreditPaymentDate,
          payoutBy: "Auto Credit to Insurance Company",
          type: "auto_credit"
        };
        updatedLedger.push(autoCreditPayment);
      }
    }

    // Add customer payment entry if customer payment section is filled
    if (isCustomerPaymentFilled) {
      const paymentAmount = parseFloat(form.inHousePaymentAmount);
      const customerRemainingAmount = calculateCustomerRemainingAmount();

      // Check if payment amount exceeds remaining amount
      if (paymentAmount > customerRemainingAmount) {
        alert(`Payment amount cannot exceed remaining amount of â‚¹${formatIndianNumber(customerRemainingAmount)}`);
        return;
      }

      // FIXED: Calculate status based on remaining amount
      const totalCustomerPayments = calculateTotalCustomerPayments();
      const totalSubventionRefund = calculateTotalSubventionRefund();
      const netPremium = Math.max(finalPremiumAmount - totalSubventionRefund, 0);
      const paymentStatus = (totalCustomerPayments + paymentAmount) >= netPremium ? 'Completed' : 'Pending';

      const customerPaymentEntry = {
        id: Date.now().toString() + '_inhouse_customer',
        date: form.inHousePaymentDate,
        description: `Customer Payment via In House - ${form.inHousePaymentMode}`,
        amount: paymentAmount,
        mode: form.inHousePaymentMode,
        status: paymentStatus, // FIXED: Dynamic status based on remaining amount
        transactionId: form.inHouseTransactionId || 'N/A',
        bankName: form.inHouseBankName || 'N/A',
        paymentMadeBy: "Customer",
        receiptDate: form.inHouseReceiptDate || form.inHousePaymentDate,
        payoutBy: "In House",
        type: "customer_payment_via_inhouse"
      };

      updatedLedger.push(customerPaymentEntry);
    }
    
    // Update auto credit status based on total customer payments
    const updatedLedgerWithAutoCreditStatus = updateAutoCreditStatus(updatedLedger);
    
    // FIXED: Update state immediately
    setPaymentLedger(updatedLedgerWithAutoCreditStatus);
    
    // FIXED: Notify parent component immediately
    if (onPaymentLedgerUpdate) {
      onPaymentLedgerUpdate(updatedLedgerWithAutoCreditStatus);
    }
    
    // Update payment status and totals
    const totalCustomerPayments = calculateTotalCustomerPayments();
    const paymentStatus = calculateOverallPaymentStatus();

    const paymentData = {
      payment_info: {
        paymentMadeBy: "In House",
        autoCreditAmount: finalPremiumAmount, // Use final premium here
        autoCreditPaymentMode: form.autoCreditPaymentMode,
        autoCreditPaymentDate: form.autoCreditPaymentDate,
        autoCreditTransactionId: form.autoCreditTransactionId || '',
        autoCreditBankName: form.autoCreditBankName || '',
        paymentMode: form.inHousePaymentMode || '',
        paymentAmount: form.inHousePaymentAmount ? parseFloat(form.inHousePaymentAmount) : 0,
        paymentDate: form.inHousePaymentDate || '',
        transactionId: form.inHouseTransactionId || '',
        receiptDate: form.inHouseReceiptDate || form.inHousePaymentDate || '',
        bankName: form.inHouseBankName || '',
        subvention_payment: "No Subvention", // In House payments don't have subvention
        paymentStatus: paymentStatus,
        totalPaidAmount: totalCustomerPayments
      },
      payment_ledger: updatedLedgerWithAutoCreditStatus
    };

    console.log("ðŸ’° Adding In House payment to ledger:", paymentData);

    try {
      // Save to backend
      await handleSave(paymentData);
      
      // Clear in house payment form (keep payment mode for convenience)
      handleChange({ target: { name: 'inHousePaymentAmount', value: '' } });
      handleChange({ target: { name: 'inHousePaymentDate', value: '' } });
      handleChange({ target: { name: 'inHouseTransactionId', value: '' } });
      handleChange({ target: { name: 'inHouseReceiptDate', value: '' } });
      handleChange({ target: { name: 'inHouseBankName', value: '' } });
      
      // Clear auto credit form if it was filled
      if (isAutoCreditFilled) {
        handleChange({ target: { name: 'autoCreditPaymentMode', value: '' } });
        handleChange({ target: { name: 'autoCreditPaymentDate', value: '' } });
        handleChange({ target: { name: 'autoCreditTransactionId', value: '' } });
        handleChange({ target: { name: 'autoCreditBankName', value: '' } });
      }
      
      alert("In House payment added to ledger successfully!");
      
    } catch (error) {
      console.error('Error saving in house payment:', error);
      alert('Error saving in house payment. Please try again.');
    }
  };

  // FIXED: Update auto credit status - Always show as Completed
  const updateAutoCreditStatus = (ledger) => {
    const autoCreditEntry = ledger.find(payment => payment.type === "auto_credit");
    
    if (autoCreditEntry) {
      // Auto credit entries should always show as Completed
      return ledger.map(payment => 
        payment.type === "auto_credit" 
          ? { ...payment, status: 'Completed' }
          : payment
      );
    }
    
    return ledger;
  };

  // DELETE PAYMENT FUNCTION
  const deletePaymentFromLedger = async (paymentId) => {
    if (!window.confirm("Are you sure you want to delete this payment?")) {
      return;
    }

    const paymentToDelete = paymentLedger.find(payment => payment.id === paymentId);
    let updatedLedger = paymentLedger.filter(payment => payment.id !== paymentId);
    
    // Update auto credit status after deletion
    updatedLedger = updateAutoCreditStatus(updatedLedger);
    
    // FIXED: Update state immediately
    setPaymentLedger(updatedLedger);
    
    // FIXED: Notify parent component immediately
    if (onPaymentLedgerUpdate) {
      onPaymentLedgerUpdate(updatedLedger);
    }
    
    // Update payment status and totals
    const totalCustomerPayments = calculateTotalCustomerPayments();
    const paymentStatus = calculateOverallPaymentStatus();

    const paymentData = {
      payment_info: {
        paymentMadeBy: form.paymentMadeBy,
        paymentMode: form.paymentMode,
        paymentAmount: 0,
        paymentDate: form.paymentDate || '',
        transactionId: form.transactionId || '',
        receiptDate: form.receiptDate || '',
        bankName: form.bankName || '',
        subvention_payment: "No Subvention",
        paymentStatus: paymentStatus,
        totalPaidAmount: totalCustomerPayments
      },
      payment_ledger: updatedLedger
    };

    console.log("ðŸ—‘ï¸ Updated payment data after deletion:", paymentData);

    try {
      // Save updated data to backend
      await handleSave(paymentData);
      
      // Update form state with new totals
      handleChange({
        target: {
          name: 'paymentStatus',
          value: paymentStatus
        }
      });

      handleChange({
        target: {
          name: 'totalPaidAmount',
          value: totalCustomerPayments
        }
      });

    } catch (error) {
      console.error('Error deleting payment:', error);
      alert('Error deleting payment. Please try again.');
    }
  };

  // Handle next step - UPDATED: Allow proceeding even if customer hasn't paid fully
  const handleNextStep = async () => {
    const totalCustomerPayments = calculateTotalCustomerPayments();
    const paymentStatus = calculateOverallPaymentStatus();
    
    const finalPaymentData = {
      payment_info: {
        paymentMadeBy: form.paymentMadeBy,
        paymentMode: form.paymentMode,
        paymentAmount: parseFloat(form.paymentAmount) || 0,
        paymentDate: form.paymentDate,
        transactionId: form.transactionId || '',
        receiptDate: form.receiptDate || '',
        bankName: form.bankName || '',
        subvention_payment: form.paymentMode.includes('Subvention') ? form.paymentMode : "No Subvention",
        paymentStatus: paymentStatus,
        totalPaidAmount: totalCustomerPayments
      },
      payment_ledger: paymentLedger
    };

    console.log("ðŸ’° Final payment data before next step:", finalPaymentData);

    // Update payment status in form
    handleChange({
      target: {
        name: 'paymentStatus',
        value: paymentStatus
      }
    });

    handleChange({
      target: {
        name: 'totalPaidAmount',
        value: totalCustomerPayments
      }
    });

    // Save current state before proceeding
    try {
      await handleSave(finalPaymentData);
      
      setTimeout(() => {
        if (onNextStep && typeof onNextStep === 'function') {
          onNextStep();
        } else {
          console.error('onNextStep is not a function');
        }
      }, 1000);
      
    } catch (error) {
      console.error('Error saving before next step:', error);
    }
  };

  // Calculate total subvention amount from ledger
  const calculateTotalSubvention = () => {
    const subventionModes = [
      "Bank Subvention", 
      "Dealer Subvention",
      "Manufacturer Subvention",
      "Special Offer Subvention",
      "Subvention" // Generic subvention
    ];
    
    return paymentLedger
      .filter(payment => 
        subventionModes.some(mode => 
          payment.mode?.toLowerCase().includes(mode.toLowerCase()) ||
          payment.description?.toLowerCase().includes('subvention')
        ) && payment.paymentMadeBy === "Customer"
      )
      .reduce((sum, payment) => sum + payment.amount, 0);
  };

  // Calculate money distribution
  const calculateAutoCreditAmountTotal = () => {
    return paymentLedger
      .filter(payment => payment.payoutBy === "Auto Credit to Insurance Company")
      .reduce((sum, payment) => sum + payment.amount, 0);
  };

  const calculateCustomerReceivedAmount = () => {
    return paymentLedger
      .filter(payment => payment.payoutBy === "Customer")
      .reduce((sum, payment) => sum + payment.amount, 0);
  };

  const calculateInHouseReceivedAmount = () => {
    return paymentLedger
      .filter(payment => payment.payoutBy === "In House")
      .reduce((sum, payment) => sum + payment.amount, 0);
  };

  // Check if auto credit entry exists
  const autoCreditExists = paymentLedger.some(payment => payment.type === "auto_credit");
  const autoCreditStatus = calculateAutoCreditStatus();
  const totalCustomerPayments = calculateTotalCustomerPayments();
  const totalSubventionRefund = calculateTotalSubventionRefund();
  const customerRemainingAmount = calculateCustomerRemainingAmount();
  const paymentProgress = calculatePaymentProgress();
  const overallPaymentStatus = calculateOverallPaymentStatus();
  const netPremium = Math.max(finalPremiumAmount - totalSubventionRefund, 0);

  // UPDATED: Check if at least one section is filled for In House payment
  const isInHousePaymentValid = () => {
    const isAutoCreditFilled = form.autoCreditPaymentMode && form.autoCreditPaymentDate;
    const isCustomerPaymentFilled = form.inHousePaymentAmount && form.inHousePaymentDate && form.inHousePaymentMode;
    return isAutoCreditFilled || isCustomerPaymentFilled;
  };

  // UPDATED: Check if payout should be disabled - Now always enabled if there are payments
  const isPayoutDisabled = paymentLedger.length === 0;

  // Ensure form fields are properly initialized - FIXED: Use final premium for auto credit
  useEffect(() => {
    const initialFields = {
      paymentMadeBy: form.paymentMadeBy || "Customer",
      customerPaymentMode: form.customerPaymentMode || "",
      customerPaymentAmount: form.customerPaymentAmount || "",
      customerPaymentDate: form.customerPaymentDate || "",
      customerTransactionId: form.customerTransactionId || "",
      customerReceiptDate: form.customerReceiptDate || "",
      customerBankName: form.customerBankName || "",
      inHousePaymentMode: form.inHousePaymentMode || "",
      inHousePaymentAmount: form.inHousePaymentAmount || "",
      inHousePaymentDate: form.inHousePaymentDate || "",
      inHouseTransactionId: form.inHouseTransactionId || "",
      inHouseReceiptDate: form.inHouseReceiptDate || "",
      inHouseBankName: form.inHouseBankName || "",
      autoCreditPaymentMode: form.autoCreditPaymentMode || "",
      autoCreditPaymentDate: form.autoCreditPaymentDate || "",
      autoCreditTransactionId: form.autoCreditTransactionId || "",
      autoCreditBankName: form.autoCreditBankName || "",
      autoCreditAmount: form.autoCreditAmount || finalPremiumAmount, // Use final premium here
      subvention_payment: form.subvention_payment || "No Subvention"
    };
    
    Object.keys(initialFields).forEach(key => {
      if (!form[key] && initialFields[key] !== "") {
        handleChange({
          target: {
            name: key,
            value: initialFields[key]
          }
        });
      }
    });
    
    // Always set to final premium amount
    setAutoCreditAmount(finalPremiumAmount);
  }, [finalPremiumAmount, totalSubventionRefund]);

  const paymentStatusColor = overallPaymentStatus === 'Fully Paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
  
  const totalSubvention = calculateTotalSubvention();
  const customerReceived = calculateCustomerReceivedAmount();
  const inHouseReceived = calculateInHouseReceivedAmount();
  const autoCreditTotal = calculateAutoCreditAmountTotal();

  // IMPROVED: Bank Suggestions Component - now field-specific
  const BankSuggestions = ({ bankType = 'customer' }) => {
    if (!showSuggestions[bankType] || bankSuggestions[bankType].length === 0) return null;

    return (
      <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
        {bankSuggestions[bankType].map((bank, index) => (
          <div
            key={bank}
            className={`px-3 py-2 cursor-pointer hover:bg-gray-100 ${
              index === activeBankIndex[bankType] ? 'bg-blue-50 border border-blue-200' : ''
            } ${index !== bankSuggestions[bankType].length - 1 ? 'border-b border-gray-100' : ''}`}
            onClick={() => handleBankSelect(bank, bankType)}
            onMouseEnter={() => setActiveBankIndex(prev => ({
              ...prev,
              [bankType]: index
            }))}
          >
            <div className="text-sm text-gray-800">{bank}</div>
          </div>
        ))}
      </div>
    );
  };

  // FIXED: Edit Form Component with proper local state management
  const EditPaymentForm = ({ payment, onSave, onCancel }) => {
    const [localEditForm, setLocalEditForm] = useState({
      date: payment.date || '',
      description: payment.description || '',
      amount: payment.amount?.toString() || '',
      mode: payment.mode || '',
      status: payment.status || 'Completed',
      transactionId: payment.transactionId || '',
      bankName: payment.bankName || '',
      paymentMadeBy: payment.paymentMadeBy || 'Customer',
      receiptDate: payment.receiptDate || payment.date || '',
      payoutBy: payment.payoutBy || 'Customer'
    });

    // FIXED: Proper input handling that maintains focus
    const handleLocalChange = (e) => {
      const { name, value } = e.target;
      
      setLocalEditForm(prev => ({
        ...prev,
        [name]: value
      }));
    };

    const handleLocalSave = () => {
      if (!localEditForm.amount || !localEditForm.date || !localEditForm.mode) {
        alert("Please fill all required fields (Amount, Date, and Payment Mode)");
        return;
      }

      const amountToSave = parseFloat(localEditForm.amount);
      if (isNaN(amountToSave) || amountToSave <= 0) {
        alert("Please enter a valid amount");
        return;
      }

      const formDataToSave = {
        ...localEditForm,
        amount: amountToSave
      };
      
      onSave(formDataToSave);
    };

    const getPaymentModeOptions = () => {
      return localEditForm.paymentMadeBy === "Customer" 
        ? customerPaymentModeOptions 
        : inHousePaymentModeOptions;
    };

    return (
      <div className="fixed inset-0 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
        <div className="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <h3 className="text-lg font-semibold mb-4">Edit Payment</h3>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Date *</label>
              <input
                type="date"
                name="date"
                value={localEditForm.date}
                onChange={handleLocalChange}
                className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                required
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Amount (â‚¹) *</label>
              <INRCurrencyInput
                type="number"
                name="amount"
                value={localEditForm.amount}
                onChange={handleLocalChange}
                className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                required
                placeholder="Enter amount"
                step="0.01"
                min="0"
              />
              <p className="text-xs text-gray-500 mt-1">
                Current: â‚¹{formatIndianNumber(payment.amount)}
              </p>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Payment Mode *</label>
              <select
                name="mode"
                value={localEditForm.mode}
                onChange={handleLocalChange}
                className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                required
              >
                <option value="">Select payment mode</option>
                {getPaymentModeOptions().map(option => (
                  <option key={option} value={option}>{option}</option>
                ))}
              </select>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Status</label>
              <select
                name="status"
                value={localEditForm.status}
                onChange={handleLocalChange}
                className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
              >
                <option value="Completed">Completed</option>
                <option value="Pending">Pending</option>
                <option value="Failed">Failed</option>
              </select>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Transaction ID</label>
              <input
                type="text"
                name="transactionId"
                value={localEditForm.transactionId}
                onChange={handleLocalChange}
                className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                placeholder="Enter transaction ID"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Bank Name</label>
              <input
                type="text"
                name="bankName"
                value={localEditForm.bankName}
                onChange={handleLocalChange}
                className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                placeholder="Enter bank name"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Description</label>
              <input
                type="text"
                name="description"
                value={localEditForm.description}
                onChange={handleLocalChange}
                className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                placeholder="Enter description"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Receipt Date</label>
              <input
                type="date"
                name="receiptDate"
                value={localEditForm.receiptDate}
                onChange={handleLocalChange}
                className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Payment Made By</label>
              <select
                name="paymentMadeBy"
                value={localEditForm.paymentMadeBy}
                onChange={handleLocalChange}
                className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                disabled
              >
                <option value="Customer">Customer</option>
                <option value="In House">In House</option>
              </select>
              <p className="text-xs text-gray-500 mt-1">Cannot be changed</p>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Payout By</label>
              <select
                name="payoutBy"
                value={localEditForm.payoutBy}
                onChange={handleLocalChange}
                className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
              >
                <option value="Customer">Customer</option>
                <option value="In House">In House</option>
                <option value="Auto Credit to Insurance Company">Auto Credit to Insurance Company</option>
              </select>
            </div>
          </div>

          <div className="mb-4 p-3 bg-gray-50 rounded-md">
            <h4 className="text-sm font-medium text-gray-700 mb-2">Original Values:</h4>
            <div className="grid grid-cols-2 gap-2 text-sm">
              <div><span className="text-gray-600">Amount:</span> â‚¹{formatIndianNumber(payment.amount)}</div>
              <div><span className="text-gray-600">Date:</span> {payment.date}</div>
              <div><span className="text-gray-600">Mode:</span> {payment.mode}</div>
              <div><span className="text-gray-600">Status:</span> {payment.status}</div>
            </div>
          </div>
          
          <div className="flex justify-end gap-3">
            <button
              onClick={onCancel}
              className="px-4 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
            >
              Cancel
            </button>
            <button
              onClick={handleLocalSave}
              className="px-4 py-2 text-sm bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors"
            >
              Save Changes
            </button>
          </div>
        </div>
      </div>
    );
  };

  // UPDATED: Subvention Form Component with one-by-one entry
  const SubventionForm = ({ 
    setShowSubventionForm, 
    calculateTotalSubventionRefund,
    finalPremiumAmount,
    formatIndianNumber 
  }) => {
    const [localSubventionEntries, setLocalSubventionEntries] = useState([]);
    const [localSubventionAmount, setLocalSubventionAmount] = useState('');
    const [localSubventionReason, setLocalSubventionReason] = useState('');

    const totalSubventionAmount = localSubventionEntries.reduce((sum, entry) => sum + entry.amount, 0);
    const totalExistingSubvention = calculateTotalSubventionRefund();
    const remainingCapacity = finalPremiumAmount - totalExistingSubvention - totalSubventionAmount;

    const handleAmountChange = (e) => {
      const value = e.target.value;
      setLocalSubventionAmount(value);
    };

    const handleAddSubventionEntry = () => {
      const amount = parseFloat(localSubventionAmount);
      if (!amount || amount <= 0) {
        alert("Please enter a valid subvention amount");
        return;
      }

      if (amount > remainingCapacity) {
        alert(`Subvention amount cannot exceed remaining capacity of â‚¹${formatIndianNumber(remainingCapacity)}`);
        return;
      }

      const newEntry = {
        id: Date.now(),
        amount: amount,
        reason: localSubventionReason || 'No reason provided'
      };
      setLocalSubventionEntries([...localSubventionEntries, newEntry]);
      setLocalSubventionAmount('');
      setLocalSubventionReason('');
    };

    const handleRemoveSubventionEntry = (id) => {
      setLocalSubventionEntries(localSubventionEntries.filter(entry => entry.id !== id));
    };

    const handleSubventionRefund = async () => {
      if (localSubventionEntries.length === 0) {
        alert("Please add at least one subvention entry");
        return;
      }

      const totalSubventionAmount = localSubventionEntries.reduce((sum, entry) => sum + entry.amount, 0);
      const totalExistingSubvention = calculateTotalSubventionRefund();
      
      if (totalSubventionAmount > finalPremiumAmount) {
        alert("Total subvention amount cannot exceed final premium amount");
        return;
      }

      try {
        // Create subvention refund entries for each subvention entry
        const subventionRefunds = localSubventionEntries.map(entry => ({
          id: Date.now().toString() + '_subvention_refund_' + entry.id,
          date: new Date().toISOString().split('T')[0],
          description: `Subvention Refund - ${entry.reason}`,
          amount: entry.amount,
          mode: "Subvention Refund",
          status: 'Completed',
          transactionId: 'N/A',
          bankName: 'N/A',
          paymentMadeBy: "In House",
          receiptDate: new Date().toISOString().split('T')[0],
          payoutBy: "Customer",
          type: "subvention_refund"
        }));

        const updatedLedger = [...paymentLedger, ...subventionRefunds];
        
        // Update auto credit status if needed
        const updatedLedgerWithAutoCreditStatus = updateAutoCreditStatus(updatedLedger);
        
        // FIXED: Update state immediately
        setPaymentLedger(updatedLedgerWithAutoCreditStatus);
        
        // FIXED: Notify parent component immediately
        if (onPaymentLedgerUpdate) {
          onPaymentLedgerUpdate(updatedLedgerWithAutoCreditStatus);
        }
        
        // Update payment status and totals
        const totalCustomerPayments = calculateTotalCustomerPayments();
        const paymentStatus = calculateOverallPaymentStatus();

        const paymentData = {
          payment_info: {
            paymentMadeBy: form.paymentMadeBy,
            paymentMode: form.paymentMode || "",
            paymentAmount: parseFloat(form.paymentAmount) || 0,
            paymentDate: form.paymentDate || '',
            transactionId: form.transactionId || '',
            receiptDate: form.receiptDate || '',
            bankName: form.bankName || '',
            subvention_payment: "Subvention Refund Applied",
            paymentStatus: paymentStatus,
            totalPaidAmount: totalCustomerPayments,
            totalSubventionRefund: totalSubventionAmount + totalExistingSubvention
          },
          payment_ledger: updatedLedgerWithAutoCreditStatus
        };

        console.log("ðŸ’° Adding subvention refunds:", paymentData);

        // Save to backend
        await handleSave(paymentData);
        
        // Clear subvention form and entries
        setLocalSubventionEntries([]);
        setLocalSubventionAmount('');
        setLocalSubventionReason('');
        setShowSubventionForm(false);
        
        alert(`Subvention refunds totaling â‚¹${formatIndianNumber(totalSubventionAmount)} added successfully!`);
        
      } catch (error) {
        console.error('Error saving subvention refund:', error);
        alert('Error saving subvention refund. Please try again.');
      }
    };

    return (
      <div className="fixed inset-0 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
        <div className="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <FaGift className="text-green-600" />
            Add Subvention Refund (One by One)
          </h3>
          
          <div className="space-y-4">
            {/* Current Subvention Summary */}
            <div className="bg-blue-50 border border-blue-200 rounded-md p-4">
              <div className="grid grid-cols-3 gap-4 text-sm">
                <div>
                  <p className="text-gray-600">Existing Subvention:</p>
                  <p className="font-semibold">â‚¹{formatIndianNumber(totalExistingSubvention)}</p>
                </div>
                <div>
                  <p className="text-gray-600">New Subvention:</p>
                  <p className="font-semibold text-green-600">â‚¹{formatIndianNumber(totalSubventionAmount)}</p>
                </div>
                <div>
                  <p className="text-gray-600">Remaining Capacity:</p>
                  <p className="font-semibold">â‚¹{formatIndianNumber(remainingCapacity)}</p>
                </div>
              </div>
            </div>

            {/* Add Subvention Entry Form */}
            <div className="border rounded-lg p-4">
              <h4 className="text-md font-semibold mb-3">Add Subvention Entry</h4>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">
                    Subvention Amount (â‚¹) *
                  </label>
                  <input
                    type="number"
                    value={localSubventionAmount}
                    onChange={handleAmountChange}
                    className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 focus:outline-none"
                    placeholder="Enter amount"
                    min="0"
                    max={remainingCapacity}
                    step="0.01"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Maximum: â‚¹{formatIndianNumber(remainingCapacity)}
                  </p>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">
                    Reason for Subvention
                  </label>
                  <input
                    type="text"
                    value={localSubventionReason}
                    onChange={(e) => setLocalSubventionReason(e.target.value)}
                    className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 focus:outline-none"
                    placeholder="e.g., Customer discount, Special offer, etc."
                  />
                </div>
              </div>
              
              <div className="mt-4 flex justify-end">
                <button
                  onClick={handleAddSubventionEntry}
                  disabled={!localSubventionAmount || parseFloat(localSubventionAmount) <= 0 || parseFloat(localSubventionAmount) > remainingCapacity}
                  className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                  <FaPlus /> Add to List
                </button>
              </div>
            </div>

            {/* Subvention Entries List */}
            {localSubventionEntries.length > 0 && (
              <div className="border rounded-lg p-4">
                <h4 className="text-md font-semibold mb-3">Subvention Entries ({localSubventionEntries.length})</h4>
                <div className="space-y-2 max-h-40 overflow-y-auto">
                  {localSubventionEntries.map((entry) => (
                    <div key={entry.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                      <div>
                        <p className="font-medium">â‚¹{formatIndianNumber(entry.amount)}</p>
                        <p className="text-sm text-gray-600">{entry.reason}</p>
                      </div>
                      <button
                        onClick={() => handleRemoveSubventionEntry(entry.id)}
                        className="text-red-600 hover:text-red-800 p-1"
                        title="Remove entry"
                      >
                        <FaTrash />
                      </button>
                    </div>
                  ))}
                </div>
                <div className="mt-3 pt-3 border-t border-gray-200">
                  <div className="flex justify-between items-center">
                    <span className="font-semibold">Total New Subvention:</span>
                    <span className="font-bold text-green-600">â‚¹{formatIndianNumber(totalSubventionAmount)}</span>
                  </div>
                </div>
              </div>
            )}

            <div className="bg-yellow-50 border border-yellow-200 rounded-md p-3">
              <p className="text-sm text-yellow-700">
                <strong>Note:</strong> Subvention reduces the amount customer needs to pay. 
                The auto credit amount will be adjusted automatically. Payout will be enabled only when customer fully pays the remaining amount.
              </p>
            </div>
          </div>
          
          <div className="flex justify-between items-center mt-6">
            <div>
              {localSubventionEntries.length > 0 && (
                <p className="text-sm text-gray-600">
                  Total: â‚¹{formatIndianNumber(totalSubventionAmount)} across {localSubventionEntries.length} entries
                </p>
              )}
            </div>
            <div className="flex gap-3">
              <button
                onClick={() => {
                  setShowSubventionForm(false);
                  setLocalSubventionEntries([]);
                  setLocalSubventionAmount('');
                  setLocalSubventionReason('');
                }}
                className="px-4 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={handleSubventionRefund}
                disabled={localSubventionEntries.length === 0}
                className="px-4 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                Apply Subvention Refunds
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="bg-white shadow-sm rounded-2xl border border-gray-200 p-6 mb-6">
      <div className="flex items-start justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-full bg-gray-100 text-gray-700">
            <FaCreditCard />
          </div>
          <h3 className="text-lg font-semibold text-gray-800">
            7: Payment
          </h3>
        </div>
        <div className="flex items-center gap-4">
          <button
            onClick={() => setShowSubventionForm(true)}
            className="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
          >
            <FaGift /> Add Subvention
          </button>
          <div className={`px-3 py-1 rounded-full text-sm font-medium ${paymentStatusColor}`}>
            {overallPaymentStatus}
          </div>
        </div>
      </div>

      {/* Payment Summary Card */}
      <div className="bg-purple-50 border rounded-xl p-5 mb-6">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <p className="text-sm text-gray-500">Final Premium:</p>
            <p className="font-semibold text-lg text-blue-600">â‚¹{formatIndianNumber(finalPremiumAmount)}</p>
            <p className="text-xs text-gray-500 mt-1">
              {acceptedQuote ? `From ${acceptedQuote.insuranceCompany}` : 'From accepted quote'}
            </p>
          </div>
          <div>
            <p className="text-sm text-gray-500">Subvention:</p>
            <p className="font-semibold text-lg text-green-600">â‚¹{formatIndianNumber(totalSubventionRefund)}</p>
          </div>
          <div>
            <p className="text-sm text-gray-500">Net Premium:</p>
            <p className="font-semibold text-lg text-purple-600">â‚¹{formatIndianNumber(netPremium)}</p>
          </div>
          <div>
            <p className="text-sm text-gray-500">Customer Paid:</p>
            <p className="font-semibold text-lg text-blue-600">â‚¹{formatIndianNumber(totalCustomerPayments)}</p>
          </div>
        </div>
        
        {/* Subvention Breakdown */}
        {totalSubventionRefund > 0 && (
          <div className="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
            <p className="text-sm font-semibold text-green-800 mb-2">Subvention Applied</p>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div>
                <span className="text-gray-600">Total Subvention:</span>
                <span className="font-semibold text-green-600 ml-2">â‚¹{formatIndianNumber(totalSubventionRefund)}</span>
              </div>
              <div>
                <span className="text-gray-600">Original Premium:</span>
                <span className="font-semibold ml-2">â‚¹{formatIndianNumber(finalPremiumAmount)}</span>
              </div>
              <div>
                <span className="text-gray-600">Customer Pays:</span>
                <span className="font-semibold text-green-600 ml-2">â‚¹{formatIndianNumber(netPremium)}</span>
              </div>
            </div>
            <p className="text-xs text-green-600 mt-2">
              âœ… Customer gets â‚¹{formatIndianNumber(totalSubventionRefund)} discount
            </p>
          </div>
        )}
        
        {/* Progress Bar - Adjusted for subvention */}
        <div className="mt-4">
          <div className="flex justify-between text-sm text-gray-600 mb-1">
            <span>Payment Progress (After Subvention)</span>
            <span>{Math.round(paymentProgress)}%</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div 
              className={`h-2 rounded-full transition-all duration-300 ${
                customerRemainingAmount <= 0 ? 'bg-green-600' : 'bg-yellow-500'
              }`}
              style={{ 
                width: `${paymentProgress}%` 
              }}
            ></div>
          </div>
          <p className="text-xs text-gray-500 mt-1">
            Progress: â‚¹{formatIndianNumber(totalCustomerPayments)} / â‚¹{formatIndianNumber(netPremium)} 
            {totalSubventionRefund > 0 && ` (After â‚¹${formatIndianNumber(totalSubventionRefund)} subvention)`}
          </p>
        </div>
      </div>

      {/* Payment Made By Radio Buttons */}
      <div className="border rounded-xl p-5 mb-6">
        <h4 className="text-md font-semibold text-gray-700 mb-4">
          Payment Made By
        </h4>
        <div className="flex gap-6">
          {paymentMadeByOptions.map((option) => (
            <label key={option.value} className="flex items-center gap-2 cursor-pointer">
              <input
                type="radio"
                name="paymentMadeBy"
                value={option.value}
                checked={form.paymentMadeBy === option.value}
                onChange={() => handleRadioChange('paymentMadeBy', option.value)}
                className="w-4 h-4 text-purple-600 focus:ring-purple-500"
              />
              <span className="text-sm font-medium text-gray-700">{option.label}</span>
            </label>
          ))}
        </div>
        {errors.paymentMadeBy && <p className="text-red-500 text-xs mt-2">{errors.paymentMadeBy}</p>}
      </div>

      {/* Customer Payment Section */}
      {form.paymentMadeBy === "Customer" && (
        <div className="border rounded-xl p-5 mb-6">
          <h4 className="text-md font-semibold text-gray-700 mb-4">
            Customer Payment
          </h4>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">
                Payment Mode *
              </label>
              <select
                name="customerPaymentMode"
                value={form.customerPaymentMode || ""}
                onChange={handleChange}
                className={`w-full border rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none ${
                  errors.customerPaymentMode ? "border-red-500" : "border-gray-300"
                }`}
              >
                <option value="">Select payment mode</option>
                {customerPaymentModeOptions.map((option) => (
                  <option key={option} value={option}>
                    {option}
                  </option>
                ))}
              </select>
              {errors.customerPaymentMode && <p className="text-red-500 text-xs mt-1">{errors.customerPaymentMode}</p>}
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">
                Payment Amount (â‚¹) *
              </label>
              <INRCurrencyInput
                type="number"
                name="customerPaymentAmount"
                value={form.customerPaymentAmount || ""}
                onChange={handleChange}
                className={`w-full border rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none ${
                  errors.customerPaymentAmount ? "border-red-500" : "border-gray-300"
                }`}
                placeholder="0"
                max={customerRemainingAmount}
                step="0.01"
              />
              {errors.customerPaymentAmount && <p className="text-red-500 text-xs mt-1">{errors.customerPaymentAmount}</p>}
              <p className="text-xs text-gray-500 mt-1">
                Maximum: â‚¹{formatIndianNumber(customerRemainingAmount)} (Customer can pay up to â‚¹{formatIndianNumber(netPremium)} total)
              </p>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">
                Payment Date *
              </label>
              <input
                type="date"
                name="customerPaymentDate"
                value={form.customerPaymentDate || ""}
                onChange={handleChange}
                className={`w-full border rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none ${
                  errors.customerPaymentDate ? "border-red-500" : "border-gray-300"
                }`}
              />
              {errors.customerPaymentDate && <p className="text-red-500 text-xs mt-1">{errors.customerPaymentDate}</p>}
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">
                Transaction ID
              </label>
              <input
                type="text"
                name="customerTransactionId"
                value={form.customerTransactionId || ""}
                onChange={handleChange}
                className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none"
                placeholder="Enter transaction ID (optional)"
              />
              <p className="text-xs text-gray-500 mt-1">Optional for cash payments</p>
            </div>

            <div className="bank-suggestions-container relative">
              <label className="block text-sm font-medium text-gray-600 mb-1">
                Bank Name
              </label>
              <input
                type="text"
                name="customerBankName"
                value={form.customerBankName || ""}
                onChange={(e) => handleBankNameChange(e, 'customer')}
                onFocus={() => handleBankFocus('customer')}
                onKeyDown={(e) => handleBankKeyDown(e, 'customer')}
                className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none"
                placeholder="Start typing bank name..."
                autoComplete="off"
              />
              <BankSuggestions bankType="customer" />
              <p className="text-xs text-gray-500 mt-1">Required for bank transfers</p>
            </div>
          </div>

          {/* Add Payment Button */}
          <div className="mt-6 flex justify-end">
            <button
              type="button"
              onClick={addCustomerPaymentToLedger}
              disabled={!form.customerPaymentAmount || !form.customerPaymentDate || !form.customerPaymentMode}
              className="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              <FaPlus /> Add Customer Payment to Ledger
            </button>
          </div>
        </div>
      )}

      {/* In House Payment Section */}
      {form.paymentMadeBy === "In House" && (
        <div className="border rounded-xl p-5 mb-6">
          <h4 className="text-md font-semibold text-gray-700 mb-4">
            In House Payment
          </h4>

          {/* Auto Credit to Insurance Company - FIXED: Always show final premium amount */}
          <div className="mb-6 p-4 border border-gray-200 rounded-lg">
            <h5 className="text-sm font-semibold text-gray-800 mb-3">Auto Credit to Insurance Company</h5>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  Amount (â‚¹) *
                </label>
                <INRCurrencyInput
                  type="number"
                  name="autoCreditAmount"
                  value={finalPremiumAmount} // Always use final premium amount
                  onChange={handleAutoCreditChange}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                  placeholder="Enter auto credit amount"
                  readOnly
                />
                <p className="text-xs text-gray-500 mt-1">
                  Auto credit amount: â‚¹{formatIndianNumber(finalPremiumAmount)} (Final Premium)
                  {totalSubventionRefund > 0 && (
                    <span className="text-green-600">
                      {" "} - After subvention: â‚¹{formatIndianNumber(netPremium)}
                    </span>
                  )}
                </p>
                {autoCreditExists && (
                  <p className={`text-xs mt-1 ${
                    autoCreditStatus === 'Completed' ? 'text-green-600' : 'text-yellow-600'
                  }`}>
                    {autoCreditStatus === 'Completed' 
                      ? 'âœ“ Auto credit completed' 
                      : `Auto credit status: ${autoCreditStatus}`}
                  </p>
                )}
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  Payment Mode *
                </label>
                <select
                  name="autoCreditPaymentMode"
                  value={form.autoCreditPaymentMode || ""}
                  onChange={handleChange}
                  className={`w-full border rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none ${
                    errors.autoCreditPaymentMode ? "border-red-500" : "border-gray-300"
                  }`}
                >
                  <option value="">Select payment mode</option>
                  {inHousePaymentModeOptions.map((option) => (
                    <option key={option} value={option}>
                      {option}
                    </option>
                  ))}
                </select>
                {errors.autoCreditPaymentMode && <p className="text-red-500 text-xs mt-1">{errors.autoCreditPaymentMode}</p>}
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  Payment Date *
                </label>
                <input
                  type="date"
                  name="autoCreditPaymentDate"
                  value={form.autoCreditPaymentDate || ""}
                  onChange={handleChange}
                  className={`w-full border rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none ${
                    errors.autoCreditPaymentDate ? "border-red-500" : "border-gray-300"
                  }`}
                />
                {errors.autoCreditPaymentDate && <p className="text-red-500 text-xs mt-1">{errors.autoCreditPaymentDate}</p>}
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  Transaction ID
                </label>
                <input
                  type="text"
                  name="autoCreditTransactionId"
                  value={form.autoCreditTransactionId || ""}
                  onChange={handleChange}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                  placeholder="Enter transaction ID (optional)"
                />
                <p className="text-xs text-gray-500 mt-1">Optional for cash payments</p>
              </div>

              <div className="bank-suggestions-container relative">
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  Bank Name
                </label>
                <input
                  type="text"
                  name="autoCreditBankName"
                  value={form.autoCreditBankName || ""}
                  onChange={(e) => handleBankNameChange(e, 'autoCredit')}
                  onFocus={() => handleBankFocus('autoCredit')}
                  onKeyDown={(e) => handleBankKeyDown(e, 'autoCredit')}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                  placeholder="Start typing bank name..."
                  autoComplete="off"
                />
                <BankSuggestions bankType="autoCredit" />
                <p className="text-xs text-gray-500 mt-1">Required for bank transfers</p>
              </div>
            </div>
          </div>

          {/* Payment Made by Customer - OPTIONAL SECTION */}
          <div className="p-4 border border-gray-200 rounded-lg mb-4">
            <h5 className="text-sm font-semibold text-gray-800 mb-3">
              Payment Made by Customer (Optional)
              <span className="ml-2 text-xs font-normal text-gray-500">- Fill only if customer has made payment</span>
            </h5>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  Payment Mode
                </label>
                <select
                  name="inHousePaymentMode"
                  value={form.inHousePaymentMode || ""}
                  onChange={handleChange}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none"
                >
                  <option value="">Select payment mode</option>
                  {customerPaymentModeOptions.map((option) => (
                    <option key={option} value={option}>
                      {option}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  Payment Amount (â‚¹)
                </label>
                <INRCurrencyInput
                  type="number"
                  name="inHousePaymentAmount"
                  value={form.inHousePaymentAmount || ""}
                  onChange={handleChange}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="0"
                  max={customerRemainingAmount}
                  step="0.01"
                />
                <p className="text-xs text-gray-500 mt-1">
                  Maximum: â‚¹{formatIndianNumber(customerRemainingAmount)} (Customer can pay up to â‚¹{formatIndianNumber(netPremium)} total)
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  Payment Date
                </label>
                <input
                  type="date"
                  name="inHousePaymentDate"
                  value={form.inHousePaymentDate || ""}
                  onChange={handleChange}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  Transaction ID
                </label>
                <input
                  type="text"
                  name="inHouseTransactionId"
                  value={form.inHouseTransactionId || ""}
                  onChange={handleChange}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="Enter transaction ID (optional)"
                />
                <p className="text-xs text-gray-500 mt-1">Optional for cash payments</p>
              </div>

              <div className="bank-suggestions-container relative">
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  Bank Name
                </label>
                <input
                  type="text"
                  name="inHouseBankName"
                  value={form.inHouseBankName || ""}
                  onChange={(e) => handleBankNameChange(e, 'inHouse')}
                  onFocus={() => handleBankFocus('inHouse')}
                  onKeyDown={(e) => handleBankKeyDown(e, 'inHouse')}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="Start typing bank name..."
                  autoComplete="off"
                />
                <BankSuggestions bankType="inHouse" />
                <p className="text-xs text-gray-500 mt-1">Required for bank transfers</p>
              </div>
            </div>
          </div>

          {/* Add Payment Button - UPDATED: Enabled if either auto credit OR customer payment is filled */}
          <div className="mt-6 flex justify-end">
            <button
              type="button"
              onClick={addInHousePaymentToLedger}
              disabled={!isInHousePaymentValid()}
              className="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              <FaPlus /> Add In House Payment to Ledger
            </button>
          </div>
        </div>
      )}

      {/* Payment Ledger Section */}
      <div className="border rounded-xl p-5">
        <div className="flex items-center justify-between mb-4">
          <h4 className="text-md font-semibold text-gray-700">
            Payment Ledger
          </h4>
          <div className="flex items-center gap-4">
            <span className="text-sm text-gray-500">
              {paymentLedger.length} payment(s) recorded
            </span>
            <span className={`px-2 py-1 rounded-full text-xs font-medium ${paymentStatusColor}`}>
              {overallPaymentStatus}
            </span>
          </div>
        </div>
        
        {paymentLedger.length > 0 ? (
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="bg-gray-50">
                  <th className="text-left p-3 font-medium text-gray-600">Date</th>
                  <th className="text-left p-3 font-medium text-gray-600">Description</th>
                  <th className="text-left p-3 font-medium text-gray-600">Payment Mode</th>
                  <th className="text-left p-3 font-medium text-gray-600">Made By</th>
                  <th className="text-left p-3 font-medium text-gray-600">Payout By</th>
                  <th className="text-right p-3 font-medium text-gray-600">Amount</th>
                  <th className="text-left p-3 font-medium text-gray-600">Status</th>
                  <th className="text-center p-3 font-medium text-gray-600">Actions</th>
                </tr>
              </thead>
              <tbody>
                {paymentLedger.map((payment) => {
                  // FIXED: Calculate dynamic status for each payment
                  const paymentStatus = calculatePaymentStatus(payment);
                  return (
                    <tr key={payment.id} className="border-b border-gray-100 hover:bg-gray-50">
                      <td className="p-3 text-gray-700">{payment.date}</td>
                      <td className="p-3 text-gray-700">
                        {payment.description}
                        {payment.type === "subvention_refund" && (
                          <span className="ml-2 px-1 bg-green-100 text-green-800 text-xs rounded">Subvention</span>
                        )}
                      </td>
                      <td className="p-3 text-gray-700">
                        {payment.mode}
                        {payment.mode.includes('Subvention') && !payment.type === "subvention_refund" && (
                          <span className="ml-2 px-1 bg-blue-100 text-blue-800 text-xs rounded">Subvention</span>
                        )}
                      </td>
                      <td className="p-3 text-gray-700">{payment.paymentMadeBy}</td>
                      <td className="p-3 text-gray-700">
                        <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs ${
                          payment.payoutBy === "Auto Credit to Insurance Company" 
                            ? "bg-green-100 text-green-800"
                            : payment.payoutBy === "Customer"
                            ? "bg-blue-100 text-blue-800"
                            : "bg-purple-100 text-purple-800"
                        }`}>
                          {payment.payoutBy}
                        </span>
                      </td>
                      <td className={`p-3 text-right font-medium ${
                        payment.type === "subvention_refund" ? "text-green-600" : "text-blue-600"
                      }`}>
                        {payment.type === "subvention_refund" ? '-' : ''}â‚¹{formatIndianNumber(payment.amount)}
                      </td>
                      <td className="p-3">
                        <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs ${
                          paymentStatus === 'Completed' 
                            ? 'bg-green-100 text-green-800' 
                            : paymentStatus === 'Pending'
                            ? 'bg-yellow-100 text-yellow-800'
                            : 'bg-red-100 text-red-800'
                        }`}>
                          {paymentStatus}
                        </span>
                      </td>
                      <td className="p-3 text-center">
                        <div className="flex gap-2 justify-center">
                          <button
                            onClick={() => handleEditPayment(payment)}
                            className="inline-flex items-center gap-1 px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition-colors"
                            title="Edit payment"
                          >
                            <FaEdit /> Edit
                          </button>
                          <button
                            onClick={() => deletePaymentFromLedger(payment.id)}
                            className="inline-flex items-center gap-1 px-3 py-1 text-xs bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition-colors"
                            title="Delete payment"
                          >
                            <FaTrash /> Delete
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
              <tfoot>
                <tr className="bg-gray-50">
                  <td colSpan="5" className="p-3 text-right font-medium text-gray-700">Total Customer Paid:</td>
                  <td className="p-3 text-right font-bold text-gray-800">
                    â‚¹{formatIndianNumber(totalCustomerPayments)}
                  </td>
                  <td className="p-3">
                    <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs ${paymentStatusColor}`}>
                      {overallPaymentStatus}
                    </span>
                  </td>
                  <td className="p-3"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        ) : (
          <div className="text-center py-8 text-gray-500">
            <FaReceipt className="mx-auto text-3xl mb-3 text-gray-300" />
            <p>No payment records found</p>
            <p className="text-sm">Add payments using the form above</p>
          </div>
        )}
      </div>

      {/* Subvention Form Modal */}
      {showSubventionForm && (
        <SubventionForm
          setShowSubventionForm={setShowSubventionForm}
          calculateTotalSubventionRefund={calculateTotalSubventionRefund}
          finalPremiumAmount={finalPremiumAmount}
          formatIndianNumber={formatIndianNumber}
        />
      )}

      {/* Edit Payment Modal */}
      {editingPayment && (
        <EditPaymentForm
          payment={paymentLedger.find(p => p.id === editingPayment)}
          onSave={handleSaveEdit}
          onCancel={handleCancelEdit}
        />
      )}

      {/* Next Step Button - UPDATED: Always enabled if there are payments */}
      {/* <div className="mt-6 flex justify-between items-center"> */}
        {/* <div className="text-sm text-gray-600">
          {paymentLedger.length > 0 ? (
            customerRemainingAmount <= 0 ? (
              <span className="text-green-600">âœ… All customer payments completed</span>
            ) : (
              <span className="text-yellow-600">âš ï¸ â‚¹{formatIndianNumber(customerRemainingAmount)} payment pending from customer</span>
            )
          ) : (
            <span className="text-red-600">Please add at least one payment</span>
          )}
        </div> */}
        
        {/* <button
          onClick={handleNextStep}
          disabled={paymentLedger.length === 0 || isSaving}
          className="inline-flex items-center gap-2 px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          {isSaving ? "Saving..." : "Proceed to Payout"} 
          <FaArrowRight />
        </button> */}
      {/* </div> */}
    </div>
  );
};    "edit payment tab is not working pls make it work i am not able to select save or change just popup opens thats it and give me fully updated code "